<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezept bearbeiten</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
    <link rel="stylesheet" th:href="@{/css/rezept.css}">
</head>

<body>
<section layout:fragment="content">
    <div class="layout-wrapper d-flex">
        <div th:replace="layout/fragments/sidebar :: arztSidebar('termine', ${arzt.titel}, ${arzt.nachname}, ${arzt.vorname}, ${arzt.mainImage})"></div>

        <div class="main-content container py-5">
            <div class="card shadow-sm rounded">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Rezept bearbeiten</h4>
                </div>
                <div class="card-body">

                    <!-- Termin-Infos -->
                    <div class="mb-4">
                        <h5 class="mb-3">Termin</h5>
                        <p><strong>Patient:</strong> <span th:text="${termin.patient.vorname + ' ' + termin.patient.nachname}">-</span></p>
                        <p><strong>Datum:</strong> <span th:text="${#temporals.format(termin.datum, 'dd.MM.yyyy')}">-</span></p>
                        <p><strong>Uhrzeit:</strong> <span th:text="${termin.uhrzeit}">-</span></p>
                    </div>

                    <!-- Rezeptformular -->
                    <form th:action="@{/arzt/termine/rezept/speichern}" method="post">
                        <input type="hidden" name="id" th:value="${rezept.id}" />
                        <input type="hidden" name="termin.id" th:value="${termin.id}" />

                        <div class="mb-3">
                            <label><strong>Diagnose:</strong></label>
                            <input type="text" name="diagnose" class="form-control" th:value="${termin.diagnose}" />
                        </div>
                        <div class="mb-3">
                            <label><strong>Notizen:</strong></label>
                            <textarea name="notizen" class="form-control" rows="3" th:text="${termin.notizen}"></textarea>
                        </div>
                        <div class="mb-3">
                            <label><strong>Rezeptbeschreibung:</strong></label>
                            <textarea name="beschreibung" class="form-control" rows="3" th:text="${rezept.beschreibung}"></textarea>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary">ğŸ’¾ Rezept speichern</button>
                        </div>
                    </form>

                    <hr class="my-5" />

                    <h5>Neues Medikament</h5>
                    <form id="medikament-form">
                        <input type="hidden" id="rezeptId" th:value="${rezept.id}" />
                        <div class="row g-2 mb-3">
                            <div class="col"><input id="name" class="form-control" placeholder="Name"></div>
                            <div class="col"><input id="dosierung" class="form-control" placeholder="Dosierung"></div>
                            <div class="col"><input id="beschreibung" class="form-control" placeholder="Beschreibung"></div>
                            <div class="col"><input id="hersteller" class="form-control" placeholder="Hersteller"></div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="hinzufuegenMedikament()">â• Medikament hinzufÃ¼gen</button>
                    </form>

                    <div id="medikament-liste" class="mt-4"></div>

                    <hr class="my-4" />

                    <h5>Vorhandene Medikamente</h5>
                    <div th:if="${rezept.medikamentList != null and !rezept.medikamentList.isEmpty()}">
                        <div th:each="med : ${rezept.medikamentList}" class="mb-3 border p-3 rounded bg-light">
                            <form class="row g-2 align-items-center" onsubmit="return updateMedikament(event, [[${med.id}]])">
                                <input type="hidden" name="id" th:value="${med.id}" />
                                <input type="hidden" name="rezeptId" th:value="${rezept.id}" />
                                <div class="col"><input name="name" class="form-control" th:value="${med.name}" /></div>
                                <div class="col"><input name="dosierung" class="form-control" th:value="${med.dosierung}" /></div>
                                <div class="col"><input name="beschreibung" class="form-control" th:value="${med.beschreibung}" /></div>
                                <div class="col"><input name="hersteller" class="form-control" th:value="${med.hersteller}" /></div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary">ğŸ’¾ Speichern</button>
                                </div>
                            </form>
                            <form th:action="@{/arzt/termine/rezept/medikament/loeschen}" method="post" class="mt-1">
                                <input type="hidden" name="id" th:value="${med.id}" />
                                <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ LÃ¶schen</button>
                            </form>
                        </div>
                    </div>
                    <div th:if="${rezept.medikamentList == null or rezept.medikamentList.isEmpty()}">
                        <p class="text-muted">Keine Medikamente vorhanden.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function hinzufuegenMedikament() {
            const rezeptId = document.getElementById('rezeptId').value;
            const name = document.getElementById('name').value;
            const dosierung = document.getElementById('dosierung').value;
            const beschreibung = document.getElementById('beschreibung').value;
            const hersteller = document.getElementById('hersteller').value;

            fetch('/arzt/termine/rezept/medikament/hinzufuegen-ajax', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rezeptId, name, dosierung, beschreibung, hersteller })
            })
                .then(res => res.json())
                .then(data => {
                    const liste = document.getElementById('medikament-liste');
                    const div = document.createElement('div');
                    div.className = 'alert alert-success';
                    div.textContent = `Medikament hinzugefÃ¼gt: ${data.name} (${data.dosierung})`;
                    liste.appendChild(div);
                    document.getElementById('medikament-form').reset();
                })
                .catch(err => console.error(err));
        }

        function updateMedikament(event, id) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            payload.id = id;

            fetch('/arzt/termine/rezept/medikament/update-ajax', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.ok ? alert('âœ… Medikament aktualisiert') : alert('âŒ Fehler beim Aktualisieren'))
                .catch(err => alert('âŒ Netzwerkfehler'));

            return false;
        }
    </script>
</section>
</body>
</html>
